import json
import requests

class SetEncoder(json.JSONEncoder):
    def default(self, o):
        if isinstance(o, set):
            return list(o)
        return super().default(o)
# Evict json file can be downloaded from this link "https://d3fend.mitre.org/tools/d3fend-extractor/?q=%5B%22d3f%3ACredentialEviction%22%2C%22d3f%3AAccountLocking%22%2C%22d3f%3AAuthenticationCacheInvalidation%22%2C%22d3f%3ACredentialRevocation%22%2C%22d3f%3AObjectEviction%22%2C%22d3f%3AEmailRemoval%22%2C%22d3f%3AFileEviction%22%2C%22d3f%3ADiskErasure%22%2C%22d3f%3ADiskPartitioning%22%2C%22d3f%3ADomainRegistrationTakedown%22%2C%22d3f%3ADiskFormatting%22%2C%22d3f%3ADNSCacheEviction%22%2C%22d3f%3ARegistryKeyDeletion%22%2C%22d3f%3AProcessEviction%22%2C%22d3f%3AProcessSuspension%22%2C%22d3f%3AHostReboot%22%2C%22d3f%3AHostShutdown%22%2C%22d3f%3ASessionTermination%22%2C%22d3f%3AProcessTermination%22%5D"
readEvictJson = open('Evict-D3FEND-Techniques.json', 'r')
readEvictJsonContents = readEvictJson.read()
readEvictJsonLoads = json.loads(readEvictJsonContents)

response = requests.get('https://d3fend.mitre.org/api/matrix-graph.json')
responseJson = response.json()
mitreMatrixGraphList = responseJson['@graph']

data_techniques = readEvictJsonLoads['techniques']
for technique in data_techniques:
    commentSplit = technique['comment'].split('\n')
    commentSplitFinal = list(filter(None, commentSplit))
    technique["commentSplit"] = commentSplitFinal
    technique["actions"] = []
    for comment in commentSplitFinal:
        for matrixGraph in mitreMatrixGraphList:
            if 'rdfs:label' in matrixGraph:
                if comment in matrixGraph['rdfs:label']:
                    defend = {}
                    defend["id"] = matrixGraph['d3f:d3fend-id'][0]
                    defend["defendName"] = matrixGraph['rdfs:label'][0]
                    defend["defendDesc"] = matrixGraph['d3f:definition'][0]
                    defend["recoverID"] = "Pending"
                    defend["recoverName"] = "Pending"
                    defend["recoverDesc"] = "Pending"
                    technique["actions"].append(defend)
print(data_techniques)



content = json.dumps(list(data_techniques), cls=SetEncoder, indent=4)
mappedOutput = open('Evict-D3FEND-Techniques-Recover-auto.json', 'w')
mappedOutput.write(content)
close = mappedOutput.close()
close_file = readEvictJson.close()
